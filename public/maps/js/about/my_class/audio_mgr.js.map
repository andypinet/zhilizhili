{"version":3,"names":[],"mappings":"","sources":["about/my_class/audio_mgr.js"],"sourcesContent":["export default function() {\n\t\tfunction audioMgr() {\n\t\t\tthis._makeStgBufferSource = bind(this._makeStgBufferSource, this);\n\t\t\tthis.playStgBgm = bind(this.playStgBgm, this);\n\t\t\tthis._eLoadedStageBgmBuffer = bind(this._eLoadedStageBgmBuffer, this);\n\t\t\tthis.loadStgBgm = bind(this.loadStgBgm, this);\n\t\t\tthis.stgBgmRate = bind(this.stgBgmRate, this);\n\t\t\tthis.getNowBgmTotalFrame = bind(this.getNowBgmTotalFrame, this);\n\t\t\tthis._playSe = bind(this._playSe, this);\n\t\t\tthis.playSeaUpSe = bind(this.playSeaUpSe, this);\n\t\t\tthis.playSeaDownSe = bind(this.playSeaDownSe, this);\n\t\t\tthis.playItemGetSe = bind(this.playItemGetSe, this);\n\t\t\tthis._eBlurWin = bind(this._eBlurWin, this);\n\t\t\tthis._eFocusWin = bind(this._eFocusWin, this);\n\t\t\tthis._update = bind(this._update, this);\n\t\t\tthis._eLoadedCmnSe = bind(this._eLoadedCmnSe, this);\n\t\t\tthis.loadCmnSe = bind(this.loadCmnSe, this);\n\t\t\tthis.start = bind(this.start, this);\n\t\t\tthis._context;\n\t\t\tthis._seBuffer = [];\n\t\t\tthis._stgBgmBuffer = [];\n\t\t\tthis._nowStageId = -1;\n\t\t\tthis._stgBgmSource;\n\t\t\tthis._stgBgmGainNode;\n\t\t\tthis._conf = root.MY.app.conf;\n\t\t\tthis._vol = 1;\n\t\t\tthis._u = root.MY.myfw.util;\n\t\t\tthis._game;\n\t\t\tthis._stgBgmTime = {\n\t\t\t\toffset: 0,\n\t\t\t\ttotal: 0,\n\t\t\t\trate: 0,\n\t\t\t\tstopTimeTotal: 0,\n\t\t\t\tstopStartTime: 0,\n\t\t\t\tisPlaying: false\n\t\t\t};\n\t\t\tthis.onProgressCmnSound;\n\t\t\tthis.onCompleteCmnSe;\n\t\t\tthis.onCompleteStageBgm;\n\t\t}\n\n\t\taudioMgr.prototype.start = function() {\n\t\t\tthis._game = root.MY.gl.game;\n\t\t\twindow.AudioContext = window.AudioContext || window.webkitAudioContext;\n\t\t\tthis._context = new AudioContext();\n\t\t\tif (!root.MY.myfw.conf.IS_SMT) {\n\t\t\t\t$(window).focus(this._eFocusWin);\n\t\t\t\treturn $(window).blur(this._eBlurWin);\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype.loadCmnSe = function() {\n\t\t\tvar loader;\n\t\t\tloader = new BufferLoader(this._context, [\"./assets/sound/se0.mp3\", \"./assets/sound/wave_in.mp3\", \"./assets/sound/wave_out.mp3\"], this._eLoadedCmnSe);\n\t\t\treturn loader.load();\n\t\t};\n\n\t\taudioMgr.prototype._eLoadedCmnSe = function(bufferList) {\n\t\t\tthis._seBuffer = bufferList;\n\t\t\tif (this.onProgressCmnSound != null) {\n\t\t\t\tthis.onProgressCmnSound(1);\n\t\t\t}\n\t\t\tif (this.onCompleteCmnSe != null) {\n\t\t\t\tthis.onCompleteCmnSe();\n\t\t\t}\n\t\t\treturn root.MY.myfw.addUpdate(this._update);\n\t\t};\n\n\t\taudioMgr.prototype._update = function() {\n\t\t\tvar ease, tgVol;\n\t\t\tif ((this._stgBgmSource != null) && this._stgBgmTime.isPlaying) {\n\t\t\t\tease = 0.1;\n\t\t\t\ttgVol = this._u.map(this._game.life(), this._conf.SOUND_VOL.MIN, this._conf.SOUND_VOL.MAX, 0, 1);\n\t\t\t\tthis._vol += (tgVol - this._vol) * ease;\n\t\t\t\tif (this._stgBgmGainNode != null) {\n\t\t\t\t\tthis._stgBgmGainNode.gain.value = this._vol;\n\t\t\t\t}\n\t\t\t\treturn this._stgBgmTime.rate = Math.min(1, (this._context.currentTime - this._stgBgmTime.offset) / (this._stgBgmTime.total + this._stgBgmTime.stopTimeTotal));\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype._eFocusWin = function() {\n\t\t\tif ((this._stgBgmSource != null) && !this._stgBgmTime.isPlaying && this._stgBgmTime.rate < 1) {\n\t\t\t\tthis._stgBgmTime.isPlaying = true;\n\t\t\t\tthis._makeStgBufferSource(this._stgBgmTime.stageId, this._stgBgmTime.stopStartTime - this._stgBgmTime.offset, false);\n\t\t\t\tthis._stgBgmTime.stopTimeTotal = this._context.currentTime - this._stgBgmTime.stopStartTime;\n\t\t\t\tthis._update();\n\t\t\t\treturn root.MY.gl.game.isUpdatePoint(true);\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype._eBlurWin = function() {\n\t\t\tif ((this._stgBgmSource != null) && this._stgBgmTime.isPlaying && this._stgBgmTime.rate < 1) {\n\t\t\t\tthis._stgBgmTime.isPlaying = false;\n\t\t\t\tthis._stgBgmSource.stop(0);\n\t\t\t\tthis._stgBgmTime.stopStartTime = this._context.currentTime;\n\t\t\t\treturn root.MY.gl.game.isUpdatePoint(false);\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype.playItemGetSe = function(combo) {\n\t\t\treturn this._playSe(0, combo * 0.5);\n\t\t};\n\n\t\taudioMgr.prototype.playSeaDownSe = function() {\n\t\t\treturn this._playSe(1);\n\t\t};\n\n\t\taudioMgr.prototype.playSeaUpSe = function() {\n\t\t\treturn this._playSe(2);\n\t\t};\n\n\t\taudioMgr.prototype._playSe = function(id, playBackRate) {\n\t\t\tvar gain, source;\n\t\t\tif (this._seBuffer[id] != null) {\n\t\t\t\tsource = this._context.createBufferSource();\n\t\t\t\tsource.buffer = this._seBuffer[id];\n\t\t\t\tsource.connect(this._context.destination);\n\t\t\t\tsource.loop = false;\n\t\t\t\tsource.playbackRate.value = playBackRate || 1;\n\t\t\t\tsource.start(0);\n\t\t\t\tgain = this._context.createGain();\n\t\t\t\tsource.connect(gain);\n\t\t\t\tgain.connect(this._context.destination);\n\t\t\t\treturn gain.gain.value = this._conf.ITEM_GET_SE_VOL;\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype.getNowBgmTotalFrame = function() {\n\t\t\tif (this._stgBgmSource != null) {\n\t\t\t\treturn this._stgBgmSource.buffer.duration * 60;\n\t\t\t} else {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype.stgBgmRate = function() {\n\t\t\treturn this._stgBgmTime.rate;\n\t\t};\n\n\t\taudioMgr.prototype.loadStgBgm = function(stageId) {\n\t\t\tvar loader;\n\t\t\tif (this._stgBgmBuffer[stageId] != null) {\n\t\t\t\tif (this.onCompleteStageBgm != null) {\n\t\t\t\t\tthis.onCompleteStageBgm();\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis._nowStageId = stageId;\n\t\t\tloader = new BufferLoader(this._context, [root.MY.app.conf.FILE_STAGE_BGM[stageId]], this._eLoadedStageBgmBuffer);\n\t\t\treturn loader.load();\n\t\t};\n\n\t\taudioMgr.prototype._eLoadedStageBgmBuffer = function(bufferList) {\n\t\t\tthis._stgBgmBuffer[this._nowStageId] = bufferList;\n\t\t\tif (this.onCompleteStageBgm != null) {\n\t\t\t\treturn this.onCompleteStageBgm();\n\t\t\t}\n\t\t};\n\n\t\taudioMgr.prototype.playStgBgm = function(stageId) {\n\t\t\tthis._makeStgBufferSource(stageId, 0, true);\n\t\t\tthis._stgBgmTime.offset = this._context.currentTime;\n\t\t\tthis._stgBgmTime.total = this._stgBgmSource.buffer.duration;\n\t\t\tthis._stgBgmTime.rate = 0;\n\t\t\tthis._stgBgmTime.isPlaying = true;\n\t\t\tthis._stgBgmTime.stopTimeTotal = 0;\n\t\t\tthis._stgBgmTime.stopStartTime = 0;\n\t\t\tthis._stgBgmTime.stageId = stageId;\n\t\t\tthis._vol = this._conf.SOUND_VOL.MIN;\n\t\t\treturn this._update();\n\t\t};\n\n\t\taudioMgr.prototype._makeStgBufferSource = function(stageId, start, isStop) {\n\t\t\tvar error;\n\t\t\tif (this._stgBgmSource != null) {\n\t\t\t\tif ((isStop != null) && isStop) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tthis._stgBgmSource.stop(0);\n\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\terror = _error;\n\t\t\t\t\t\tconsole.log(error);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis._stgBgmSource = null;\n\t\t\t}\n\t\t\tthis._stgBgmSource = this._context.createBufferSource();\n\t\t\tthis._stgBgmSource.buffer = this._stgBgmBuffer[stageId][0];\n\t\t\tthis._stgBgmSource.connect(this._context.destination);\n\t\t\tthis._stgBgmSource.loop = false;\n\t\t\tthis._stgBgmSource.start(0, start || 0);\n\t\t\tthis._stgBgmGainNode = this._context.createGain();\n\t\t\tthis._stgBgmSource.connect(this._stgBgmGainNode);\n\t\t\treturn this._stgBgmGainNode.connect(this._context.destination);\n\t\t};\n\n\t\treturn audioMgr;\n\n\t}"],"file":"about/my_class/audio_mgr.js","sourceRoot":"/source/"}